# PicMe - 基本設計書

**作成日**: 2026-01-19
**最終更新日**: 2026-01-20
**バージョン**: 1.1
**ステータス**: 確定

---

## 1. システム概要

### 1.1 システム構成

```
┌─────────────────────────────────────────────────────┐
│              ユーザー（ブラウザ）                    │
└─────────────────────────────────────────────────────┘
                         ↓ HTTPS
┌─────────────────────────────────────────────────────┐
│          フロントエンド（Next.js）                   │
│              Vercel CDN                             │
└─────────────────────────────────────────────────────┘
                         ↓ REST API
┌─────────────────────────────────────────────────────┐
│         バックエンド（Spring Boot）                  │
│              Railway                                │
└─────────────────────────────────────────────────────┘
          ↓                              ↓
┌──────────────────┐            ┌──────────────────┐
│  PostgreSQL      │            │  Cloudinary      │
│  (Railway)       │            │  (画像CDN)       │
└──────────────────┘            └──────────────────┘
```

### 1.2 技術スタック

| レイヤー | 技術 |
|---------|------|
| フロントエンド | Next.js 15, React 19, TypeScript, TailwindCSS |
| バックエンド | Spring Boot 3.x, Java 17+ |
| データベース | PostgreSQL 15 |
| インフラ | Vercel, Railway, Cloudinary |
| 認証 | JWT, OAuth 2.0 (Twitter, Google) |
| 決済 | Stripe |

---

## 2. アーキテクチャ設計

### 2.1 アプリケーション構成

#### フロントエンド構成

```
├── app/
│   ├── (auth)/              # 認証関連ページ
│   │   ├── login/
│   │   ├── signup/
│   │   └── oauth-callback/
│   ├── (dashboard)/         # ダッシュボード
│   │   ├── dashboard/
│   │   ├── settings/
│   │   └── upgrade/
│   ├── [username]/          # 公開プロフィールページ (例: /johndoe)
│   ├── layout.tsx
│   └── page.tsx
├── components/
│   ├── ui/                  # UIコンポーネント
│   ├── gallery/             # ギャラリー関連
│   ├── profile/             # プロフィール関連
│   └── layout/              # レイアウト関連
├── lib/
│   ├── api/                 # API通信
│   ├── hooks/               # カスタムHooks
│   └── utils/               # ユーティリティ
└── styles/
    └── globals.css

#### フロントエンドURL設計

| URLパターン | 説明 | 例 |
|-----------|------|-----|
| `/{username}` | 公開プロフィールページ | `/johndoe` |
| `/login` | ログインページ | `/login` |
| `/signup` | 新規登録ページ | `/signup` |
| `/dashboard` | ダッシュボード | `/dashboard` |
| `/artworks` | 作品管理 | `/artworks` |
| `/profile` | プロフィール編集 | `/profile` |
| `/social-links` | SNSリンク管理 | `/social-links` |

**注**: APIエンドポイントは `/api/users/:username` ですが、フロントエンドの公開ページURLは `/{username}` です。
```

#### バックエンド構成

```
backend/
└── src/main/java/com/picme/
    ├── config/              # 設定クラス
    │   ├── SecurityConfig.java
    │   ├── OAuth2Config.java
    │   └── CloudinaryConfig.java
    ├── controller/          # コントローラー
    │   ├── AuthController.java
    │   ├── UserController.java
    │   ├── ProfileController.java
    │   ├── ArtworkController.java
    │   └── SubscriptionController.java
    ├── service/             # サービス層
    │   ├── AuthService.java
    │   ├── UserService.java
    │   ├── ProfileService.java
    │   └── ArtworkService.java
    ├── repository/          # リポジトリ層
    │   ├── UserRepository.java
    │   ├── ProfileRepository.java
    │   └── ArtworkRepository.java
    ├── model/               # エンティティ
    │   ├── User.java
    │   ├── Profile.java
    │   └── Artwork.java
    ├── dto/                 # データ転送オブジェクト
    │   ├── request/
    │   └── response/
    ├── security/            # セキュリティ
    │   ├── JwtTokenProvider.java
    │   └── JwtAuthenticationFilter.java
    └── exception/           # 例外処理
        └── GlobalExceptionHandler.java
```

### 2.2 レイヤー構成

```
┌─────────────────────────────────────┐
│         Presentation Layer           │
│         (Controller)                 │
├─────────────────────────────────────┤
│         Business Logic Layer         │
│         (Service)                    │
├─────────────────────────────────────┤
│         Data Access Layer            │
│         (Repository / JPA)           │
├─────────────────────────────────────┤
│         Database Layer               │
│         (PostgreSQL)                 │
└─────────────────────────────────────┘
```

---

## 3. データベース設計

### 3.1 ER図

```
┌──────────────┐       ┌──────────────┐
│   users      │ 1   1 │  profiles    │
│──────────────│───────│──────────────│
│ id (PK)      │       │ id (PK)      │
│ username     │       │ user_id (FK) │
│ email        │       │ display_name │
│ password     │       │ bio          │
│ oauth_provider│      │ avatar_url   │
│ created_at   │       │ header_url   │
└──────────────┘       └──────────────┘
        │
        │ 1
        │
        │ *
┌──────────────┐       ┌──────────────┐
│  artworks    │       │ social_links │
│──────────────│       │──────────────│
│ id (PK)      │       │ id (PK)      │
│ user_id (FK) │       │ user_id (FK) │
│ title        │       │ platform     │
│ description  │       │ url          │
│ image_url    │       │ order        │
│ category     │       └──────────────┘
│ display_order│
└──────────────┘

┌──────────────┐       ┌──────────────┐
│subscriptions │       │    posts     │
│──────────────│       │──────────────│
│ id (PK)      │       │ id (PK)      │
│ user_id (FK) │       │ user_id (FK) │
│ plan_type    │       │ title        │
│ status       │       │ content      │
│ stripe_id    │       │ published_at │
└──────────────┘       └──────────────┘
```

### 3.2 テーブル定義

#### users テーブル
```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255),
    oauth_provider VARCHAR(20),
    oauth_id VARCHAR(255),
    email_verified BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### profiles テーブル
```sql
CREATE TABLE profiles (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    display_name VARCHAR(100),
    bio TEXT,
    avatar_url VARCHAR(500),
    header_url VARCHAR(500),
    theme VARCHAR(50) DEFAULT 'default',
    color_primary VARCHAR(7),
    color_accent VARCHAR(7),
    font_family VARCHAR(50),
    layout VARCHAR(20) DEFAULT 'grid',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### artworks テーブル
```sql
CREATE TABLE artworks (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(200),
    description TEXT,
    image_url VARCHAR(500) NOT NULL,
    cloudinary_public_id VARCHAR(255),
    category VARCHAR(50),
    display_order INT DEFAULT 0,
    visible BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### social_links テーブル
```sql
CREATE TABLE social_links (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    platform VARCHAR(50) NOT NULL,
    url VARCHAR(500) NOT NULL,
    icon VARCHAR(100),
    display_order INT DEFAULT 0,
    visible BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### subscriptions テーブル
```sql
CREATE TABLE subscriptions (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    plan_type VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL,
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### posts テーブル
```sql
CREATE TABLE posts (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    published_at TIMESTAMP,
    visible BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### artwork_tags テーブル（Pro以上）
```sql
CREATE TABLE artwork_tags (
    id BIGSERIAL PRIMARY KEY,
    artwork_id BIGINT NOT NULL REFERENCES artworks(id) ON DELETE CASCADE,
    tag_name VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### artwork_categories テーブル（Pro以上）
```sql
CREATE TABLE artwork_categories (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    display_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### page_views テーブル（アクセス解析）
```sql
CREATE TABLE page_views (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    visitor_ip VARCHAR(45),
    referrer VARCHAR(500),
    user_agent VARCHAR(500),
    viewed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### inquiries テーブル（問い合わせ管理）
```sql
CREATE TABLE inquiries (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
    name VARCHAR(100),
    email VARCHAR(255) NOT NULL,
    subject VARCHAR(200) NOT NULL,
    message TEXT NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### admin_users テーブル（管理者ユーザー）
```sql
CREATE TABLE admin_users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) DEFAULT 'ADMIN',
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 4. API設計

### 4.1 認証API

| エンドポイント | メソッド | 説明 | 認証 |
|--------------|---------|------|------|
| `/api/auth/signup` | POST | ユーザー登録 | 不要 |
| `/api/auth/login` | POST | ログイン | 不要 |
| `/api/auth/logout` | POST | ログアウト | 必要 |
| `/api/auth/refresh` | POST | トークン更新 | 必要 |
| `/api/auth/oauth/twitter` | GET | Twitter OAuth開始 | 不要 |
| `/api/auth/oauth/google` | GET | Google OAuth開始 | 不要 |
| `/api/auth/oauth/callback` | GET | OAuth コールバック | 不要 |

### 4.2 ユーザーAPI

| エンドポイント | メソッド | 説明 | 認証 |
|--------------|---------|------|------|
| `/api/users/me` | GET | 自分の情報取得 | 必要 |
| `/api/users/:username` | GET | 公開プロフィール取得 | 不要 |
| `/api/users/check-username` | POST | ユーザー名重複チェック | 不要 |

### 4.3 プロフィールAPI

| エンドポイント | メソッド | 説明 | 認証 |
|--------------|---------|------|------|
| `/api/profile` | GET | プロフィール取得 | 必要 |
| `/api/profile` | PUT | プロフィール更新 | 必要 |
| `/api/profile/avatar` | POST | アバター画像アップロード | 必要 |
| `/api/profile/header` | POST | ヘッダー画像アップロード | 必要 |

### 4.4 作品API

| エンドポイント | メソッド | 説明 | 認証 |
|--------------|---------|------|------|
| `/api/artworks` | GET | 作品一覧取得（自分） | 必要 |
| `/api/artworks/:id` | GET | 作品詳細取得 | 必要 |
| `/api/artworks` | POST | 作品アップロード | 必要 |
| `/api/artworks/:id` | PUT | 作品更新 | 必要 |
| `/api/artworks/:id` | DELETE | 作品削除 | 必要 |
| `/api/artworks/reorder` | PUT | 作品並び替え | 必要 |

### 4.5 SNSリンクAPI

| エンドポイント | メソッド | 説明 | 認証 |
|--------------|---------|------|------|
| `/api/social-links` | GET | SNSリンク一覧取得 | 必要 |
| `/api/social-links` | POST | SNSリンク追加 | 必要 |
| `/api/social-links/:id` | PUT | SNSリンク更新 | 必要 |
| `/api/social-links/:id` | DELETE | SNSリンク削除 | 必要 |

### 4.6 サブスクリプションAPI

| エンドポイント | メソッド | 説明 | 認証 |
|--------------|---------|------|------|
| `/api/subscriptions/checkout` | POST | 決済セッション作成 | 必要 |
| `/api/subscriptions/webhook` | POST | Stripe Webhook受信 | 不要 |
| `/api/subscriptions/status` | GET | サブスクリプション状態 | 必要 |
| `/api/subscriptions/cancel` | POST | サブスクリプション解約 | 必要 |

### 4.7 管理者API

| エンドポイント | メソッド | 説明 | 認証 |
|--------------|---------|------|------|
| `/api/admin/dashboard` | GET | ダッシュボード統計取得 | 管理者 |
| `/api/admin/users` | GET | ユーザー一覧取得 | 管理者 |
| `/api/admin/users/:id` | GET | ユーザー詳細取得 | 管理者 |
| `/api/admin/users/:id/suspend` | POST | ユーザーアカウント停止 | 管理者 |
| `/api/admin/users/:id/activate` | POST | ユーザーアカウント有効化 | 管理者 |
| `/api/admin/subscriptions` | GET | サブスク一覧取得 | 管理者 |
| `/api/admin/subscriptions/stats` | GET | サブスク統計取得 | 管理者 |
| `/api/admin/inquiries` | GET | 問い合わせ一覧取得 | 管理者 |
| `/api/admin/inquiries/:id` | GET | 問い合わせ詳細取得 | 管理者 |
| `/api/admin/inquiries/:id/status` | PUT | 問い合わせステータス更新 | 管理者 |
| `/api/admin/system/metrics` | GET | システムメトリクス取得 | 管理者 |

---

## 5. 認証・認可設計

### 5.1 認証フロー

#### メール + パスワード認証

```
1. ユーザー: POST /api/auth/signup
   - email, password, username送信
2. サーバー: ユーザー作成、確認メール送信
3. ユーザー: メール内のリンクをクリック
4. サーバー: email_verifiedをtrueに更新
5. ユーザー: POST /api/auth/login
6. サーバー: JWT（アクセストークン + リフレッシュトークン）発行
7. クライアント: JWTをlocalStorageに保存
8. 以降のリクエスト: Authorization: Bearer <JWT>
```

#### OAuth認証（Twitter）

```
1. ユーザー: GET /api/auth/oauth/twitter
2. サーバー: Twitter OAuth URLにリダイレクト
3. ユーザー: Twitterで認証・許可
4. Twitter: /api/auth/oauth/callback?code=XXX にコールバック
5. サーバー:
   - codeを使ってアクセストークン取得
   - ユーザー情報取得
   - ユーザー作成/更新
   - JWT発行
6. クライアント: JWTを保存
```

### 5.2 JWT構造

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_id",
    "username": "username",
    "email": "email@example.com",
    "role": "USER",
    "plan": "PRO",
    "iat": 1234567890,
    "exp": 1234567890
  }
}
```

### 5.3 プラン制限チェック

```java
@Component
public class PlanLimitChecker {

    // プロフィール画像アップロード制限
    public void checkProfileImageUploadLimit(User user) {
        PlanType plan = user.getSubscription().getPlanType();

        int limit = switch (plan) {
            case FREE, STARTER, PRO -> 1;
            case STUDIO -> Integer.MAX_VALUE; // 無制限
        };

        // プロフィール画像は1枚のみなので、既存チェック
        if (user.getProfile().getAvatarUrl() != null && limit == 1) {
            throw new LimitExceededException("プロフィール画像のアップロード上限に達しています");
        }
    }

    // ヘッダー画像アップロード制限
    public void checkHeaderImageUploadLimit(User user) {
        PlanType plan = user.getSubscription().getPlanType();

        int limit = switch (plan) {
            case FREE, STARTER, PRO -> 1;
            case STUDIO -> Integer.MAX_VALUE; // 無制限
        };

        // ヘッダー画像は1枚のみなので、既存チェック
        if (user.getProfile().getHeaderUrl() != null && limit == 1) {
            throw new LimitExceededException("ヘッダー画像のアップロード上限に達しています");
        }
    }

    // ギャラリー画像アップロード制限
    public void checkGalleryImageUploadLimit(User user) {
        PlanType plan = user.getSubscription().getPlanType();
        long currentCount = artworkRepository.countByUserId(user.getId());

        int limit = switch (plan) {
            case FREE -> 5;
            case STARTER -> 20;
            case PRO -> 50;
            case STUDIO -> 200;
        };

        if (currentCount >= limit) {
            throw new LimitExceededException("ギャラリー画像のアップロード上限に達しています");
        }
    }
}
```

---

## 6. 画像管理設計

### 6.1 画像アップロードフロー

```
1. クライアント: 画像選択（ドラッグ&ドロップ）
2. クライアント: 画像をBase64エンコード、または直接送信
3. クライアント: POST /api/artworks（multipart/form-data）
4. サーバー:
   - プラン制限チェック
   - ファイル検証（MIME type、サイズ、拡張子）
   - Cloudinaryにアップロード
   - DBに保存（image_url, cloudinary_public_id）
5. サーバー: レスポンス返却
6. クライアント: プレビュー表示
```

### 6.2 Cloudinary設定

```java
@Configuration
public class CloudinaryConfig {

    @Bean
    public Cloudinary cloudinary() {
        return new Cloudinary(ObjectUtils.asMap(
            "cloud_name", cloudName,
            "api_key", apiKey,
            "api_secret", apiSecret
        ));
    }
}
```

### 6.3 画像変換・最適化

```
アップロード時:
- 自動WebP変換
- 自動圧縮（quality: 80）
- サムネイル生成（width: 400）

配信時:
- CDN経由で配信
- レスポンシブ画像（複数サイズ）
- Lazy Loading
```

---

## 7. プラン制限設計

### 7.1 プラン別制限一覧

| 機能 | Free | Starter | Pro | Studio |
|-----|------|---------|-----|--------|
| プロフィール画像 | 1 | 1 | 1 | 無制限 |
| ヘッダー画像 | 1 | 1 | 1 | 無制限 |
| ギャラリー画像 | 5 | 20 | 50 | 200 |
| 画像容量 | 300MB | 1GB | 2GB | 10GB |
| SNSリンク | 2 | 5 | 10 | 無制限 |
| お知らせ | 1 | 5 | 20 | 無制限 |
| カテゴリー | 0 | 0 | 5 | 無制限 |
| タグ（作品ごと） | 0 | 0 | 3 | 無制限 |
| カスタムページ | 0 | 1 | 3 | 10 |
| 広告表示 | あり | なし | なし | なし |

### 7.2 制限チェック実装

```java
@Aspect
@Component
public class PlanLimitAspect {

    @Before("@annotation(CheckPlanLimit)")
    public void checkLimit(JoinPoint joinPoint) {
        User user = getCurrentUser();
        CheckPlanLimit annotation = getAnnotation(joinPoint);

        switch (annotation.limitType()) {
            case PROFILE_IMAGE_UPLOAD:
                checkProfileImageLimit(user);
                break;
            case HEADER_IMAGE_UPLOAD:
                checkHeaderImageLimit(user);
                break;
            case GALLERY_IMAGE_UPLOAD:
                checkGalleryImageLimit(user);
                break;
            case SNS_LINK:
                checkSnsLinkLimit(user);
                break;
            // ...
        }
    }

    // プロフィール画像制限チェック
    private void checkProfileImageLimit(User user) {
        PlanType plan = user.getSubscription().getPlanType();
        int currentCount = profileImageRepository.countByUserId(user.getId());

        int limit = switch (plan) {
            case FREE, STARTER, PRO -> 1;
            case STUDIO -> Integer.MAX_VALUE; // 無制限
        };

        if (currentCount >= limit) {
            throw new LimitExceededException("プロフィール画像のアップロード上限に達しています");
        }
    }

    // ヘッダー画像制限チェック
    private void checkHeaderImageLimit(User user) {
        PlanType plan = user.getSubscription().getPlanType();
        int currentCount = headerImageRepository.countByUserId(user.getId());

        int limit = switch (plan) {
            case FREE, STARTER, PRO -> 1;
            case STUDIO -> Integer.MAX_VALUE; // 無制限
        };

        if (currentCount >= limit) {
            throw new LimitExceededException("ヘッダー画像のアップロード上限に達しています");
        }
    }

    // ギャラリー画像制限チェック
    private void checkGalleryImageLimit(User user) {
        PlanType plan = user.getSubscription().getPlanType();
        long currentCount = artworkRepository.countByUserId(user.getId());

        int limit = switch (plan) {
            case FREE -> 5;
            case STARTER -> 20;
            case PRO -> 50;
            case STUDIO -> 200;
        };

        if (currentCount >= limit) {
            throw new LimitExceededException("ギャラリー画像のアップロード上限に達しています");
        }
    }
}
```

---

## 7.3 広告表示設計（Google AdSense）

### 7.3.1 広告表示対象

- **Freeプラン**のみ広告を表示
- Starter以上は広告非表示

### 7.3.2 広告表示位置

**ファーストビュー内（スクロールなしで見える位置）**:

| 表示位置 | 広告フォーマット | サイズ |
|---------|----------------|--------|
| ① ヘッダー画像直下 | ディスプレイ広告 | 728x90（PC）/ 320x50（モバイル） |
| ② プロフィール情報・SNSリンク下 | ディスプレイ広告 | 336x280 |
| ③ ギャラリータイトル下 | レスポンシブ広告 | レスポンシブ |

**ギャラリーエリア**:

| 表示位置 | 広告フォーマット | サイズ |
|---------|----------------|--------|
| ④ ギャラリー内（5作品ごと） | インフィード広告 | レスポンシブ |

### 7.3.3 実装方法

```javascript
// クライアント側でプラン判定後、広告スクリプトを条件付き読み込み
{user.subscription.planType === 'FREE' && (
  <Script
    async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
    data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
  />
)}
```

### 7.3.4 収益試算

- **RPM（1,000PVあたりの収益）**: ¥300
- **Freeプラン想定PV**: 1人あたり月10PV
- **8,550人 × 10PV = 85,500PV/月**
- **月間広告収益**: ¥25,650

---

## 8. セキュリティ設計

### 8.1 認証・認可

- **JWT（JSON Web Token）**
  - アクセストークン: 有効期限15分
  - リフレッシュトークン: 有効期限7日
- **OAuth 2.0**（Twitter、Google）
- **BCrypt**によるパスワードハッシュ化（strength: 12）

### 8.2 CORS設定

```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        CorsConfiguration config = new CorsConfiguration();
        config.setAllowedOrigins(Arrays.asList(
            "http://localhost:3001",
            "https://picme.com",
            "https://*.picme.com"
        ));
        config.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE"));
        config.setAllowedHeaders(Arrays.asList("*"));
        config.setAllowCredentials(true);
        return new CorsFilter(source);
    }
}
```

### 8.3 レート制限

```java
@Configuration
public class RateLimitConfig {
    // Bucket4jを使用
    // 例: 1ユーザーにつき 100リクエスト/分

    @Bean
    public RateLimitFilter rateLimitFilter() {
        return new RateLimitFilter(100, Duration.ofMinutes(1));
    }
}
```

### 8.4 入力検証

- **バリデーション**: Hibernate Validator
- **サニタイゼーション**: OWASP Java HTML Sanitizer
- **ファイルアップロード検証**:
  - MIME typeチェック（image/jpeg, image/png, image/gif, image/webp）
  - ファイルサイズ制限（最大10MB）
  - 拡張子ホワイトリスト

---

## 9. パフォーマンス設計

### 9.1 キャッシュ戦略

```java
@Cacheable(value = "userProfile", key = "#username")
public ProfileDTO getUserProfile(String username) {
    // ...
}

@CacheEvict(value = "userProfile", key = "#username")
public void updateProfile(String username, ProfileDTO profile) {
    // ...
}
```

### 9.2 データベース最適化

- **インデックス**:
  - users.username
  - users.email
  - artworks.user_id
  - artworks.visible
- **N+1問題対策**: Eager Loading
- **ページネーション**: ページサイズ20

### 9.3 画像最適化

- Cloudinary自動最適化
- WebP変換
- レスポンシブ画像
- Lazy Loading

---

## 10. 監視・ログ設計

### 10.1 ログレベル

| レベル | 用途 |
|-------|------|
| ERROR | エラー、例外 |
| WARN | 警告、潜在的な問題 |
| INFO | 重要なイベント |
| DEBUG | 開発時のデバッグ情報 |

### 10.2 ログ出力項目

```
[timestamp] [level] [username] [endpoint] [method] [status] [duration]
```

### 10.3 監視項目

- サーバーレスポンス時間
- エラー率
- データベースクエリ時間
- 画像アップロード成功率
- プラン別転換率

---

## 11. デプロイメント設計

### 11.1 環境構成

| 環境 | 用途 | URL |
|-----|------|-----|
| Development | 開発環境（ローカル） | http://localhost:3000 |
| Staging | ステージング環境 | https://staging.picme.com |
| Production | 本番環境 | https://picme.com |

### 11.2 CI/CD パイプライン

```yaml
# GitHub Actions
name: Deploy
on:
  push:
    branches: [main]

jobs:
  frontend:
    - Checkout
    - Build Next.js
    - Run tests
    - Deploy to Vercel

  backend:
    - Checkout
    - Build Spring Boot
    - Run tests
    - Deploy to Railway
```

---

## 12. バックアップ・障害対策

### 12.1 バックアップ

- **データベース**: 毎日自動バックアップ（Railway）
- **画像**: Cloudinaryで自動保持
- **保持期間**: 30日

### 12.2 障害対策

- **自動復旧**: Railwayの自動再起動
- **フェイルオーバー**: データベースのレプリカ（将来）
- **ロールバック**: Git tagによるバージョン管理

---

**承認者**: _____________
**承認日**: _____________

**END OF DOCUMENT**
