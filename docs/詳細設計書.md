# PicMe - 詳細設計書

**作成日**: 2026-01-19
**最終更新日**: 2026-02-07
**バージョン**: 2.0（v4.6対応）
**ステータス**: 確定

---

## 1. 画面設計

### 1.1 画面一覧

| 画面ID | 画面名 | URL | 認証 | 説明 |
|-------|--------|-----|------|------|
| A01 | トップページ | `/` | 不要 | サービス紹介、ログイン/新規登録 |
| A02 | 新規登録 | `/signup` | 不要 | ユーザー登録フォーム |
| A03 | ログイン | `/login` | 不要 | ログインフォーム |
| A04 | メール認証 | `/verify-email` | 不要 | メール認証トークン処理（v4.3） |
| A05 | パスワード忘れ | `/forgot-password` | 不要 | メールアドレス入力（v4.3） |
| A06 | パスワードリセット | `/reset-password` | 不要 | 新パスワード入力（v4.3） |
| B01 | ダッシュボード | `/dashboard` | 必要 | ユーザーホーム画面 |
| B02 | プロフィール編集 | `/dashboard/profile` | 必要 | プロフィール編集 |
| B03 | 作品管理 | `/dashboard/artworks` | 必要 | 作品アップロード・管理・D&D並び替え |
| B04 | SNSリンク管理 | `/dashboard/social-links` | 必要 | SNSリンク編集・D&D並び替え |
| B05 | お知らせ管理 | `/dashboard/posts` | 必要 | お知らせ投稿管理・Markdownエディタ |
| B06 | カテゴリー管理 | `/dashboard/categories` | 必要（PRO+） | カテゴリー管理 |
| B07 | プラン・課金 | `/dashboard/upgrade` | 必要 | プラン変更、決済 |
| B08 | アクセス解析 | `/dashboard/analytics` | 必要（PRO+） | PV解析ダッシュボード（v4.4） |
| B09 | カスタムCSS | `/dashboard/custom-css` | 必要（PRO+） | CSSエディタ＋ライブプレビュー（v4.4） |
| B10 | テーマ設定 | `/dashboard/themes` | 必要 | テーマカスタマイズ |
| B11 | タグ管理 | `/dashboard/tags` | 必要（PRO+） | タグ管理 |
| C01 | 公開ページ | `/{username}` | 不要 | ユーザーの公開ページ |
| D01 | 管理者ダッシュボード | `/admin/dashboard` | 管理者 | 統計情報、KPI |
| D02 | ユーザー管理 | `/admin/users` | 管理者 | ユーザー一覧・詳細 |
| D03 | サブスク管理 | `/admin/subscriptions` | 管理者 | プラン別統計 |
| D04 | 問い合わせ管理 | `/admin/inquiries` | 管理者 | サポート対応 |
| D05 | システム監視 | `/admin/system` | 管理者 | リソース監視 |

### 1.2 画面遷移図

```
トップ(A01)
  ├→ 新規登録(A02) → メール認証(A04) → ダッシュボード(B01)
  └→ ログイン(A03)
       ├→ ダッシュボード(B01)
       └→ パスワード忘れ(A05) → パスワードリセット(A06) → ログイン(A03)

ダッシュボード(B01)  ※サイドバーから各画面に遷移
  ├→ プロフィール編集(B02)
  ├→ 作品管理(B03)         ※D&D並び替え対応
  ├→ SNSリンク管理(B04)     ※D&D並び替え対応
  ├→ お知らせ管理(B05)      ※Markdownエディタ対応（PRO+）
  ├→ カテゴリー管理(B06)    ※PRO以上
  ├→ プラン・課金(B07)
  ├→ アクセス解析(B08)      ※PRO以上
  ├→ カスタムCSS(B09)       ※PRO以上
  ├→ テーマ設定(B10)
  ├→ タグ管理(B11)          ※PRO以上
  └→ 公開ページ(C01)

公開ページ(C01)
  └→ 問い合わせフォーム      ※PRO以上のユーザーページのみ

管理者ダッシュボード(D01)
  ├→ ユーザー管理(D02)
  ├→ サブスク管理(D03)
  ├→ 問い合わせ管理(D04)
  └→ システム監視(D05)
```

---

## 2. 画面詳細設計

### 2.1 A02: 新規登録画面

#### レイアウト

```
┌─────────────────────────────────────┐
│          PicMe ロゴ                  │
│                                     │
│  アカウントを作成                    │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ ユーザー名 *                  │  │
│  │ [___________________________]│  │
│  │ 半角英数字、3〜20文字         │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ メールアドレス *              │  │
│  │ [___________________________]│  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │ パスワード *                  │  │
│  │ [___________________________]│  │
│  │ 8文字以上、英数字記号含む     │  │
│  └───────────────────────────────┘  │
│                                     │
│  [ ] 利用規約に同意する             │
│                                     │
│  [ 登録する ]                       │
│                                     │
│  または                             │
│                                     │
│  [ Twitter で登録 ]                 │
│  [ Google で登録 ]                  │
│                                     │
│  既にアカウントをお持ちですか？      │
│  ログイン                           │
└─────────────────────────────────────┘
```

#### バリデーション

| 項目 | ルール |
|-----|--------|
| ユーザー名 | 必須、3〜20文字、半角英数字とハイフン・アンダースコアのみ、重複チェック |
| メールアドレス | 必須、メール形式、重複チェック |
| パスワード | 必須、8文字以上、英数字記号を含む |
| 利用規約 | 必須、チェック必要 |

---

### 2.2 B01: ダッシュボード画面

#### レイアウト

```
┌─────────────────────────────────────────────────┐
│ [ PicMe ] [プロフィール▼] [ログアウト]         │
├─────────────────────────────────────────────────┤
│  ダッシュボード                                  │
│                                                 │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐│
│  │ 作品       │ │ ページ     │ │ フォロワー │││
│  │ 15/50枚   │ │ ビュー     │ │ (準備中)   │││
│  │           │ │ 1,234回    │ │            │││
│  └────────────┘ └────────────┘ └────────────┘││
│                                                 │
│  クイックアクション                             │
│  [ 作品をアップロード ]  [ プロフィール編集 ]   │
│  [ 公開ページを見る ]                           │
│                                                 │
│  最近の作品                                     │
│  ┌──────┐ ┌──────┐ ┌──────┐               │
│  │[img] │ │[img] │ │[img] │               │
│  │title │ │title │ │title │               │
│  └──────┘ └──────┘ └──────┘               │
│                                                 │
│  ⚠️ あと35枚でProプランの上限です               │
│  [ Proプランを見る ]                            │
└─────────────────────────────────────────────────┘
```

---

### 2.3 B03: 作品管理画面

#### レイアウト

```
┌─────────────────────────────────────────────────┐
│ 作品管理                         [ + 新規追加 ]  │
├─────────────────────────────────────────────────┤
│  フィルター:                                     │
│  [ すべて ▼ ] [ カテゴリー ▼ ]                  │
│                                                 │
│  検索: [________________]                       │
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │ ドラッグして並び替え                      │  │
│  │                                          │  │
│  │ ┌────────────────────────────────────┐  │  │
│  │ │ [📷] 作品タイトル1          [編集]  │  │  │
│  │ │      説明文...            [削除]  │  │  │
│  │ │      カテゴリー: イラスト   [👁]  │  │  │
│  │ │      2026-01-15              表示  │  │  │
│  │ └────────────────────────────────────┘  │  │
│  │                                          │  │
│  │ ┌────────────────────────────────────┐  │  │
│  │ │ [📷] 作品タイトル2          [編集]  │  │  │
│  │ │      説明文...            [削除]  │  │  │
│  │ │      カテゴリー: マンガ     [👁]  │  │  │
│  │ │      2026-01-14              表示  │  │  │
│  │ └────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────┘  │
│                                                 │
│  15 / 50 件                    [ 1 | 2 | 3 ]   │
└─────────────────────────────────────────────────┘
```

#### 画像アップロードモーダル

```
┌─────────────────────────────────────┐
│  作品をアップロード           [×]   │
├─────────────────────────────────────┤
│                                     │
│  ┌───────────────────────────────┐  │
│  │                               │  │
│  │   ドラッグ&ドロップ           │  │
│  │   または                      │  │
│  │   [ ファイルを選択 ]          │  │
│  │                               │  │
│  │   JPG, PNG, GIF, WebP         │  │
│  │   最大10MB                    │  │
│  └───────────────────────────────┘  │
│                                     │
│  タイトル                           │
│  [_________________________________]│
│                                     │
│  説明文                             │
│  [_________________________________]│
│  [_________________________________]│
│  [_________________________________]│
│                                     │
│  カテゴリー (Pro)                   │
│  [ イラスト ▼ ]                    │
│                                     │
│  タグ (Pro)                         │
│  [_________________________________]│
│  カンマ区切りで入力                 │
│                                     │
│  [ キャンセル ]    [ アップロード ] │
└─────────────────────────────────────┘
```

---

### 2.4 B07: プラン・課金画面

#### レイアウト

```
┌─────────────────────────────────────────────────────────────┐
│  プラン・課金                                                │
├─────────────────────────────────────────────────────────────┤
│  現在のプラン: Free                                          │
│                                                             │
│  ┌──────────┬──────────┬──────────┬──────────┐           │
│  │  Free    │ Starter  │ Pro ⭐   │ Studio   │           │
│  │          │          │ 人気No.1 │          │           │
│  ├──────────┼──────────┼──────────┼──────────┤           │
│  │  ¥0      │  ¥480    │  ¥680    │ ¥1,980   │           │
│  │          │          │ +¥200!   │          │           │
│  ├──────────┼──────────┼──────────┼──────────┤           │
│  │ 画像10枚 │ 画像20枚 │ 画像50枚 │ 画像200枚│           │
│  │ SNS2個   │ SNS5個   │ SNS10個  │ SNS無制限│           │
│  │ 広告あり │ 広告なし │ 広告なし │ 広告なし │           │
│  │          │          │ カテゴリ │ 独自ドメ │           │
│  │          │          │ 解析あり │ イン対応 │           │
│  ├──────────┼──────────┼──────────┼──────────┤           │
│  │ 現在の   │ [申込]   │ [14日無料]│ [詳しく] │           │
│  │ プラン   │          │          │          │           │
│  └──────────┴──────────┴──────────┴──────────┘           │
│                                                             │
│  💡 Starterとの差額はたった¥200で機能が全然違います！       │
│                                                             │
│  プラン比較表を見る                                         │
└─────────────────────────────────────────────────────────────┘
```

---

### 2.5 C01: 公開ページ

#### レイアウト（デスクトップ - Freeプラン）

```
┌─────────────────────────────────────────────────┐
│              ヘッダー画像                        │
│                                                 │
│    ┌────┐                                      │
│    │アイ│  表示名                              │
│    │コン│  @username                           │
│    └────┘                                      │
│                                                 │
│    自己紹介文...                                │
│                                                 │
│    [Twitter] [Instagram] [Pixiv]               │
├─────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────┐│
│  │ ① [ Google AdSense 広告 ]                 ││
│  │     728x90 (PC) / 320x50 (Mobile)         ││
│  │     ヘッダー画像直下                      ││
│  └───────────────────────────────────────────┘││
├─────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────┐│
│  │ ② [ Google AdSense 広告 ]                 ││
│  │     336x280                               ││
│  │     プロフィール情報・SNSリンク下         ││
│  └───────────────────────────────────────────┘││
├─────────────────────────────────────────────────┤
│  [ 作品 ]  [ お知らせ ]                         │
├─────────────────────────────────────────────────┤
│  カテゴリー: [ すべて ] [ イラスト ] [ マンガ ] │
│                                                 │
│  ┌───────────────────────────────────────────┐│
│  │ ③ [ Google AdSense 広告 ]                 ││
│  │     レスポンシブ                          ││
│  │     ギャラリータイトル下                  ││
│  └───────────────────────────────────────────┘││
│                                                 │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐       │
│  │ img  │ │ img  │ │ img  │ │ img  │       │
│  │title │ │title │ │title │ │title │       │
│  └──────┘ └──────┘ └──────┘ └──────┘       │
│                                                 │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐       │
│  │ img  │ │ img  │ │ img  │ │ img  │       │
│  │title │ │title │ │title │ │title │       │
│  └──────┘ └──────┘ └──────┘ └──────┘       │
│                                                 │
│  ┌───────────────────────────────────────────┐│
│  │ ④ [ Google AdSense インフィード広告 ]      ││
│  │     レスポンシブ                          ││
│  │     ギャラリー内（5作品ごとに表示）       ││
│  └───────────────────────────────────────────┘││
│                                                 │
│  [ もっと見る ]                                 │
├─────────────────────────────────────────────────┤
│  Powered by PicMe                               │
└─────────────────────────────────────────────────┘
```

**注記**:
- 上記はFreeプランのレイアウトです
- Starter/Pro/Studioプランでは広告は表示されません
- ①②③はファーストビュー内（スクロールせずに見える位置）に配置

---

## 2.6 管理者画面

### 2.6.1 D01: 管理者ダッシュボード

#### レイアウト

```
┌─────────────────────────────────────────────────┐
│ [ PicMe Admin ] [ログアウト]                    │
├─────────────────────────────────────────────────┤
│  管理者ダッシュボード                            │
│                                                 │
│  ┌──────────┬──────────┬──────────┬──────────┐│
│  │ 総ユーザー│ 有料会員  │ 月間収益  │ 広告収益  ││
│  │ 10,000人 │ 1,600人  │ ¥1,238K  │ ¥25K     ││
│  └──────────┴──────────┴──────────┴──────────┘││
│                                                 │
│  プラン別ユーザー数                              │
│  ┌─────────────────────────────────────────┐  │
│  │ Free: 8,400人 (84%)                     │  │
│  │ Starter: 550人 (5.5%)                   │  │
│  │ Pro: 850人 (8.5%)                       │  │
│  │ Studio: 200人 (2%)                      │  │
│  └─────────────────────────────────────────┘  │
│                                                 │
│  最近の登録ユーザー                              │
│  ┌─────────────────────────────────────────┐  │
│  │ username1 | Free    | 2026-01-20 10:00  │  │
│  │ username2 | Pro     | 2026-01-20 09:45  │  │
│  │ username3 | Starter | 2026-01-20 09:30  │  │
│  └─────────────────────────────────────────┘  │
│                                                 │
│  [ ユーザー管理 ] [ サブスク管理 ] [ 問い合わせ ]│
└─────────────────────────────────────────────────┘
```

---

### 2.6.2 D02: ユーザー管理画面

#### レイアウト

```
┌─────────────────────────────────────────────────┐
│  ユーザー管理                                    │
├─────────────────────────────────────────────────┤
│  検索: [________________] [ プラン▼ ] [検索]   │
│                                                 │
│  ┌─────────────────────────────────────────┐  │
│  │ ID | ユーザー名 | プラン | 登録日 | 操作 │  │
│  ├─────────────────────────────────────────┤  │
│  │ 1  | artist123  | Pro    | 2026-01 | [詳細]│  │
│  │ 2  | illust456  | Free   | 2026-01 | [詳細]│  │
│  │ 3  | manga789   | Studio | 2025-12 | [詳細]│  │
│  └─────────────────────────────────────────┘  │
│                                                 │
│  [ 1 | 2 | 3 | ... | 100 ]                     │
└─────────────────────────────────────────────────┘
```

#### ユーザー詳細モーダル

```
┌─────────────────────────────────────┐
│  ユーザー詳細                  [×]  │
├─────────────────────────────────────┤
│  ID: 123                            │
│  ユーザー名: artist123               │
│  メール: artist@example.com          │
│  プラン: Pro（¥680/月）              │
│  登録日: 2026-01-15                 │
│  最終ログイン: 2026-01-20 10:00      │
│                                     │
│  利用状況:                           │
│  - ギャラリー画像: 25/50枚           │
│  - ストレージ: 800MB/2GB            │
│  - SNSリンク: 5/10個                │
│                                     │
│  操作:                              │
│  [ アカウント停止 ]                  │
│  [ プラン変更 ]                      │
│  [ ストレージリセット ]              │
│                                     │
│  [ 閉じる ]                         │
└─────────────────────────────────────┘
```

---

### 2.6.3 D03: サブスクリプション管理画面

#### レイアウト

```
┌─────────────────────────────────────────────────┐
│  サブスクリプション管理                          │
├─────────────────────────────────────────────────┤
│  プラン別統計                                    │
│                                                 │
│  ┌──────────┬──────────┬──────────┬──────────┐│
│  │  Free    │ Starter  │  Pro     │ Studio   ││
│  ├──────────┼──────────┼──────────┼──────────┤│
│  │ 8,400人  │  550人   │  850人   │  200人   ││
│  │  84%     │  5.5%    │  8.5%    │   2%     ││
│  │  ¥0      │ ¥264K    │ ¥578K    │ ¥396K    ││
│  └──────────┴──────────┴──────────┴──────────┘││
│                                                 │
│  最近のサブスクリプション                        │
│  ┌─────────────────────────────────────────┐  │
│  │ユーザー | プラン | ステータス | 開始日   │  │
│  ├─────────────────────────────────────────┤  │
│  │user123  | Pro    | Active    | 2026-01-20│  │
│  │user456  | Starter| Active    | 2026-01-19│  │
│  │user789  | Studio | Cancelled | 2026-01-18│  │
│  └─────────────────────────────────────────┘  │
│                                                 │
│  チャーン率（解約率）: 2.5%/月                   │
│  MRR（月次経常収益）: ¥1,238,000                 │
└─────────────────────────────────────────────────┘
```

---

### 2.6.4 D04: 問い合わせ管理画面

#### レイアウト

```
┌─────────────────────────────────────────────────┐
│  問い合わせ管理                                  │
├─────────────────────────────────────────────────┤
│  [ 未対応 ] [ 対応中 ] [ 完了 ]                 │
│                                                 │
│  ┌─────────────────────────────────────────┐  │
│  │ ID | ユーザー | 件名 | ステータス | 日時 │  │
│  ├─────────────────────────────────────────┤  │
│  │ 1  | user123  | 画像アップロードエラー     │  │
│  │    |          |      | 未対応 | 2026-01-20│  │
│  ├─────────────────────────────────────────┤  │
│  │ 2  | user456  | プラン変更について        │  │
│  │    |          |      | 対応中 | 2026-01-19│  │
│  └─────────────────────────────────────────┘  │
│                                                 │
│  [ 詳細 ] をクリックで問い合わせ内容を表示       │
└─────────────────────────────────────────────────┘
```

---

### 2.6.5 D05: システム監視画面

#### レイアウト

```
┌─────────────────────────────────────────────────┐
│  システム監視                                    │
├─────────────────────────────────────────────────┤
│  リソース使用状況                                │
│                                                 │
│  ┌──────────┬──────────┬──────────┐          │
│  │  CPU     │ メモリ    │ ディスク  │          │
│  ├──────────┼──────────┼──────────┤          │
│  │  45%     │  62%     │  38%     │          │
│  │  正常     │  正常     │  正常     │          │
│  └──────────┴──────────┴──────────┘          │
│                                                 │
│  Cloudinaryストレージ                            │
│  ┌─────────────────────────────────────────┐  │
│  │  使用量: 156GB / 500GB (31%)            │  │
│  │  月間転送量: 2.3TB                      │  │
│  └─────────────────────────────────────────┘  │
│                                                 │
│  データベース                                    │
│  ┌─────────────────────────────────────────┐  │
│  │  接続数: 45 / 100                       │  │
│  │  レスポンス時間: 23ms（平均）            │  │
│  └─────────────────────────────────────────┘  │
│                                                 │
│  エラーログ（直近24時間）                        │
│  ┌─────────────────────────────────────────┐  │
│  │  500エラー: 3件                         │  │
│  │  400エラー: 127件                       │  │
│  └─────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

---

## 3. バリデーションルール一覧

### 3.1 用語定義

| 用語 | 英語名 | 説明 |
|-----|-------|------|
| ユーザーID | `id` | 内部識別子（データベース主キー、自動採番） |
| ユーザー名 | `username` | ログイン・URL用の一意識別子（例: `/@username`） |
| 表示名 | `displayName` | プロフィールに表示される名前 |

### 3.2 認証・ユーザー関連

| 項目 | 最小 | 最大 | 形式・ルール |
|-----|-----|-----|-------------|
| ユーザー名 | 3文字 | 20文字 | 半角英数字、ハイフン、アンダースコアのみ |
| メールアドレス | - | 255文字 | メール形式（RFC 5322準拠） |
| パスワード | 8文字 | 100文字 | 英数字記号を含む |

### 3.3 プロフィール関連

| 項目 | 最小 | 最大 | 形式・ルール |
|-----|-----|-----|-------------|
| 表示名 | - | 32文字 | - |
| 自己紹介 | - | 500文字 | - |
| アバターURL | - | 500文字 | URL形式 |
| ヘッダーURL | - | 500文字 | URL形式 |
| カラーコード | 7文字 | 7文字 | HEX形式（例: `#FF0000`） |

### 3.4 作品関連

| 項目 | 最小 | 最大 | 形式・ルール |
|-----|-----|-----|-------------|
| 作品タイトル | 1文字 | 200文字 | 必須 |
| 作品説明 | - | 1000文字 | - |
| 画像URL | 1文字 | 500文字 | 必須、URL形式 |

### 3.5 カテゴリー・タグ関連

| 項目 | 最小 | 最大 | 形式・ルール |
|-----|-----|-----|-------------|
| カテゴリー名 | 1文字 | 50文字 | 必須、ユーザー内で重複不可 |
| タグ名 | 1文字 | 30文字 | 必須 |

### 3.6 SNSリンク関連

| 項目 | 最小 | 最大 | 形式・ルール |
|-----|-----|-----|-------------|
| プラットフォーム名 | 1文字 | 50文字 | 必須 |
| URL | 1文字 | 500文字 | 必須、URL形式 |

### 3.7 投稿（お知らせ）関連

| 項目 | 最小 | 最大 | 形式・ルール |
|-----|-----|-----|-------------|
| 投稿タイトル | 1文字 | 200文字 | 必須 |
| 投稿内容 | 1文字 | 10000文字 | 必須 |
| サムネイルURL | - | 500文字 | URL形式 |
| コンテンツ形式 | - | 20文字 | PLAIN or MARKDOWN（v4.5、PRO以上でMARKDOWN使用可） |

### 3.8 カスタムCSS関連（v4.4）

| 項目 | 最小 | 最大 | 形式・ルール |
|-----|-----|-----|-------------|
| カスタムCSS | - | 10,000文字 | PRO: 100行以内, STUDIO: 500行以内 |

**禁止パターン（CssSanitizer）**: `@import`, `url()`, `expression()`, `javascript:`, `behavior:`, `-moz-binding`

### 3.9 問い合わせ関連（v4.4）

| 項目 | 最小 | 最大 | 形式・ルール |
|-----|-----|-----|-------------|
| 名前 | 1文字 | 100文字 | 必須 |
| メールアドレス | - | 255文字 | メール形式 |
| 件名 | 1文字 | 200文字 | 必須 |
| メッセージ | 1文字 | 2000文字 | 必須 |

### 3.10 画像アップロード関連（v4.2）

| 項目 | 制限 | 形式・ルール |
|-----|------|-------------|
| ファイルサイズ | 最大10MB | - |
| MIMEタイプ | - | image/jpeg, image/png, image/gif, image/webp のみ |

### 3.11 プラン別制限

| 項目 | FREE | STARTER | PRO | STUDIO |
|-----|------|---------|-----|--------|
| ギャラリー画像 | 5枚 | 20枚 | 50枚 | 200枚 |
| ストレージ容量 | 300MB | 1GB | 2GB | 10GB |
| SNSリンク | 2個 | 5個 | 10個 | 無制限 |
| お知らせ投稿 | 1件 | 5件 | 20件 | 無制限 |
| カテゴリー | - | - | 5個 | 無制限 |
| タグ | - | - | 使用可 | 使用可 |
| カスタムCSS | - | - | 100行 | 500行 |
| Markdownエディタ | - | - | 使用可 | 使用可 |
| 問い合わせフォーム | - | - | 使用可 | 使用可 |
| アクセス解析 | - | - | 使用可 | 使用可 |
| 広告表示 | あり | なし | なし | なし |

---

## 4. API詳細設計

### 3.1 認証API

#### POST `/api/auth/signup`

**リクエスト**:
```json
{
  "username": "artist123",
  "email": "artist@example.com",
  "password": "SecurePass123!"
}
```

**レスポンス（成功）**:
```json
{
  "success": true,
  "message": "確認メールを送信しました",
  "data": {
    "userId": 1,
    "username": "artist123",
    "email": "artist@example.com"
  }
}
```

**レスポンス（エラー）**:
```json
{
  "success": false,
  "error": {
    "code": "USERNAME_ALREADY_EXISTS",
    "message": "このユーザー名は既に使用されています"
  }
}
```

**エラーコード**:
- `USERNAME_ALREADY_EXISTS`: ユーザー名重複
- `EMAIL_ALREADY_EXISTS`: メールアドレス重複
- `INVALID_USERNAME_FORMAT`: ユーザー名形式不正
- `PASSWORD_TOO_WEAK`: パスワードが弱い

---

#### POST `/api/auth/login`

**リクエスト**:
```json
{
  "email": "artist@example.com",
  "password": "SecurePass123!"
}
```

**レスポンス（成功）**:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "username": "artist123",
      "email": "artist@example.com",
      "emailVerified": true,
      "subscription": {
        "planType": "PRO",
        "status": "ACTIVE"
      }
    },
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIs...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
      "expiresIn": 900
    }
  }
}
```

**エラーコード**:
- `INVALID_CREDENTIALS`: メールアドレスまたはパスワードが間違っている
- `EMAIL_NOT_VERIFIED`: メールアドレス未確認
- `ACCOUNT_DISABLED`: アカウントが無効化されている

---

### 3.2 作品API

#### POST `/api/artworks`

**リクエスト**（multipart/form-data）:
```
image: (file) [binary data]
title: "新作イラスト"
description: "キャラクターデザインです"
category: "illustration"
tags: "オリジナル,女の子,デジタル"
```

**レスポンス（成功）**:
```json
{
  "success": true,
  "data": {
    "id": 123,
    "title": "新作イラスト",
    "description": "キャラクターデザインです",
    "imageUrl": "https://res.cloudinary.com/.../image.jpg",
    "thumbnailUrl": "https://res.cloudinary.com/.../image_thumb.jpg",
    "category": "illustration",
    "tags": ["オリジナル", "女の子", "デジタル"],
    "displayOrder": 0,
    "visible": true,
    "createdAt": "2026-01-19T10:00:00Z"
  }
}
```

**エラーコード**:
- `LIMIT_EXCEEDED`: プラン制限超過
- `FILE_TOO_LARGE`: ファイルサイズ超過（10MB以上）
- `INVALID_FILE_TYPE`: 許可されていないファイル形式
- `UPLOAD_FAILED`: アップロード失敗

---

#### PUT `/api/artworks/reorder`

**リクエスト**:
```json
{
  "orders": [
    { "id": 1, "order": 0 },
    { "id": 2, "order": 1 },
    { "id": 3, "order": 2 }
  ]
}
```

**レスポンス（成功）**:
```json
{
  "success": true,
  "message": "並び順を更新しました"
}
```

---

### 3.3 サブスクリプションAPI

#### POST `/api/subscriptions/checkout`

**リクエスト**:
```json
{
  "planType": "PRO",
  "billingCycle": "MONTHLY"
}
```

**レスポンス（成功）**:
```json
{
  "success": true,
  "data": {
    "sessionId": "cs_test_...",
    "checkoutUrl": "https://checkout.stripe.com/c/pay/cs_test_..."
  }
}
```

---

#### POST `/api/subscriptions/webhook`

**Stripeからのリクエスト**:
```json
{
  "type": "checkout.session.completed",
  "data": {
    "object": {
      "id": "cs_test_...",
      "customer": "cus_...",
      "subscription": "sub_...",
      "client_reference_id": "user_123"
    }
  }
}
```

**処理内容**:
1. Stripe署名検証
2. イベントタイプに応じた処理
   - `checkout.session.completed`: サブスクリプション作成
   - `invoice.payment_succeeded`: 支払い成功
   - `customer.subscription.deleted`: サブスクリプション削除

---

## 4. データフロー設計

### 4.1 画像アップロードフロー

```
クライアント                バックエンド               Cloudinary
    │                          │                          │
    │ 1. 画像選択                │                          │
    ├──────────────────────────>│                          │
    │ POST /api/artworks         │                          │
    │ (multipart/form-data)      │                          │
    │                          │ 2. プラン制限チェック      │
    │                          │                          │
    │                          │ 3. ファイル検証            │
    │                          │                          │
    │                          │ 4. Cloudinaryアップロード  │
    │                          ├─────────────────────────>│
    │                          │                          │
    │                          │<─────────────────────────┤
    │                          │ 5. 画像URL返却            │
    │                          │                          │
    │                          │ 6. DB保存                │
    │                          │                          │
    │<──────────────────────────┤                          │
    │ 7. レスポンス返却          │                          │
    │                          │                          │
    │ 8. プレビュー表示          │                          │
```

### 4.2 OAuth認証フロー（Twitter）

```
クライアント         バックエンド         Twitter
    │                   │                   │
    │ 1. Twitter で登録  │                   │
    ├──────────────────>│                   │
    │ GET /oauth/twitter │                   │
    │                   │ 2. 認証URLリダイレクト│
    │<──────────────────┤                   │
    │                   │                   │
    │ 3. Twitter認証画面へ                   │
    ├──────────────────────────────────────>│
    │                   │                   │
    │ 4. 認証・許可      │                   │
    │                   │                   │
    │ 5. コールバック    │                   │
    │<──────────────────────────────────────┤
    │ GET /oauth/callback?code=XXX          │
    │                   │                   │
    ├──────────────────>│ 6. アクセストークン取得│
    │                   ├──────────────────>│
    │                   │<──────────────────┤
    │                   │ 7. ユーザー情報取得   │
    │                   ├──────────────────>│
    │                   │<──────────────────┤
    │                   │                   │
    │                   │ 8. ユーザー作成/更新  │
    │                   │ 9. JWT発行        │
    │<──────────────────┤                   │
    │ 10. JWT返却        │                   │
```

---

## 5. エラー処理設計

### 5.1 エラーレスポンス形式

```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "ユーザー向けメッセージ",
    "details": {
      "field": "username",
      "reason": "既に使用されています"
    },
    "timestamp": "2026-01-19T10:00:00Z",
    "requestId": "req_abc123"
  }
}
```

### 5.2 HTTPステータスコード

| コード | 説明 | 使用例 |
|-------|------|--------|
| 200 | 成功 | データ取得成功 |
| 201 | 作成成功 | ユーザー登録成功 |
| 204 | 成功（内容なし） | 削除成功 |
| 400 | リクエスト不正 | バリデーションエラー |
| 401 | 認証エラー | JWT無効、期限切れ |
| 403 | 権限エラー | プラン制限超過 |
| 404 | 見つからない | ユーザーが存在しない |
| 409 | 競合 | ユーザー名重複 |
| 429 | レート制限 | リクエスト過多 |
| 500 | サーバーエラー | 予期しないエラー |

### 5.3 エラーコード一覧

#### 認証関連（AUTH_XXX）
- `AUTH_INVALID_CREDENTIALS`: 認証情報が無効
- `AUTH_TOKEN_EXPIRED`: トークン期限切れ
- `AUTH_TOKEN_INVALID`: トークンが無効
- `AUTH_EMAIL_NOT_VERIFIED`: メール未確認

#### ユーザー関連（USER_XXX）
- `USER_NOT_FOUND`: ユーザーが見つからない
- `USER_USERNAME_EXISTS`: ユーザー名重複
- `USER_EMAIL_EXISTS`: メールアドレス重複

#### プラン制限関連（LIMIT_XXX）
- `LIMIT_PROFILE_IMAGE_UPLOAD`: プロフィール画像アップロード上限
- `LIMIT_HEADER_IMAGE_UPLOAD`: ヘッダー画像アップロード上限
- `LIMIT_GALLERY_IMAGE_UPLOAD`: ギャラリー画像アップロード上限
- `LIMIT_SNS_LINK`: SNSリンク上限
- `LIMIT_STORAGE`: ストレージ容量上限
- `LIMIT_FEATURE_NOT_AVAILABLE`: 機能が使用不可（プラン制限）

#### ファイル関連（FILE_XXX）
- `FILE_TOO_LARGE`: ファイルサイズ超過
- `FILE_INVALID_TYPE`: ファイル形式不正
- `FILE_UPLOAD_FAILED`: アップロード失敗

---

## 6. テストケース設計

### 6.1 ユニットテスト

#### AuthService - signup()

| No | テストケース | 期待結果 |
|----|------------|---------|
| 1 | 正常なユーザー登録 | ユーザー作成成功、確認メール送信 |
| 2 | ユーザー名重複 | `USER_USERNAME_EXISTS`エラー |
| 3 | メールアドレス重複 | `USER_EMAIL_EXISTS`エラー |
| 4 | 無効なユーザー名形式 | バリデーションエラー |
| 5 | 弱いパスワード | `PASSWORD_TOO_WEAK`エラー |

#### PlanLimitChecker - checkProfileImageUploadLimit()

| No | テストケース | 期待結果 |
|----|------------|---------|
| 1 | Freeプラン、1枚目アップロード | 成功 |
| 2 | Freeプラン、2枚目アップロード（既存あり） | `LIMIT_PROFILE_IMAGE_UPLOAD`エラー |
| 3 | Studioプラン、5枚目アップロード | 成功（無制限） |

#### PlanLimitChecker - checkHeaderImageUploadLimit()

| No | テストケース | 期待結果 |
|----|------------|---------|
| 1 | Proプラン、1枚目アップロード | 成功 |
| 2 | Proプラン、2枚目アップロード（既存あり） | `LIMIT_HEADER_IMAGE_UPLOAD`エラー |
| 3 | Studioプラン、10枚目アップロード | 成功（無制限） |

#### PlanLimitChecker - checkGalleryImageUploadLimit()

| No | テストケース | 期待結果 |
|----|------------|---------|
| 1 | Freeプラン、4枚目アップロード | 成功 |
| 2 | Freeプラン、5枚目アップロード | 成功 |
| 3 | Freeプラン、6枚目アップロード | `LIMIT_GALLERY_IMAGE_UPLOAD`エラー |
| 4 | Proプラン、49枚目アップロード | 成功 |
| 5 | Proプラン、50枚目アップロード | 成功 |
| 6 | Proプラン、51枚目アップロード | `LIMIT_GALLERY_IMAGE_UPLOAD`エラー |
| 7 | Studioプラン、199枚目アップロード | 成功 |
| 8 | Studioプラン、200枚目アップロード | 成功 |
| 9 | Studioプラン、201枚目アップロード | `LIMIT_GALLERY_IMAGE_UPLOAD`エラー |

### 6.2 統合テスト

#### ユーザー登録〜ログインフロー

| No | ステップ | 期待結果 |
|----|---------|---------|
| 1 | POST /api/auth/signup | 201 Created |
| 2 | メール確認リンククリック | メール確認成功 |
| 3 | POST /api/auth/login | 200 OK、JWTトークン返却 |
| 4 | GET /api/users/me（JWT付き） | 200 OK、ユーザー情報返却 |

#### 画像アップロード〜公開フロー

| No | ステップ | 期待結果 |
|----|---------|---------|
| 1 | POST /api/artworks（画像） | 201 Created、Cloudinary URL返却 |
| 2 | GET /api/artworks | 200 OK、アップロードした画像を含むリスト |
| 3 | PUT /api/artworks/:id（visible=true） | 200 OK |
| 4 | GET /@username | 200 OK、画像が公開ページに表示 |

### 6.3 E2Eテスト（Playwright）

#### シナリオ1: 新規ユーザー登録〜作品アップロード

```
1. トップページにアクセス
2. 「新規登録」ボタンをクリック
3. ユーザー名、メール、パスワードを入力
4. 「登録する」ボタンをクリック
5. メール確認画面が表示される
6. （メール確認リンクは手動でクリック）
7. ログインページにアクセス
8. メール、パスワードを入力してログイン
9. ダッシュボードに遷移
10. 「作品をアップロード」ボタンをクリック
11. 画像ファイルを選択
12. タイトル、説明文を入力
13. 「アップロード」ボタンをクリック
14. 作品一覧に追加される
15. 「公開ページを見る」をクリック
16. 公開ページにアップロードした作品が表示される
```

---

## 7. パフォーマンス設計

### 7.1 レスポンス時間目標

| API | 目標レスポンス時間 |
|-----|------------------|
| GET /api/users/:username | < 200ms |
| GET /api/artworks | < 300ms |
| POST /api/artworks | < 2,000ms（画像アップロード含む） |
| POST /api/auth/login | < 500ms |

### 7.2 同時接続数目標

- 同時接続数: 1,000人
- リクエスト数: 10,000 req/min

### 7.3 データベースクエリ最適化

#### N+1問題対策

```java
// ❌ N+1問題
List<User> users = userRepository.findAll();
users.forEach(user -> {
    Profile profile = profileRepository.findByUserId(user.getId()); // N回実行
});

// ✅ Eager Loading
@Query("SELECT u FROM User u LEFT JOIN FETCH u.profile")
List<User> findAllWithProfile();
```

#### インデックス設計

```sql
-- 頻繁に検索されるカラム
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_artworks_user_id ON artworks(user_id);
CREATE INDEX idx_artworks_visible ON artworks(visible);
CREATE INDEX idx_artworks_user_visible ON artworks(user_id, visible);

-- 複合インデックス
CREATE INDEX idx_artworks_category_visible ON artworks(category, visible);
```

---

## 8. セキュリティ詳細設計

### 8.1 SQL インジェクション対策

```java
// ✅ JPA Prepared Statement使用
@Query("SELECT u FROM User u WHERE u.username = :username")
User findByUsername(@Param("username") String username);

// ❌ 文字列結合（脆弱）
// String sql = "SELECT * FROM users WHERE username = '" + username + "'";
```

### 8.2 XSS対策

```java
// サニタイゼーション
import org.owasp.html.PolicyFactory;
import org.owasp.html.Sanitizers;

public String sanitizeHtml(String input) {
    PolicyFactory policy = Sanitizers.FORMATTING.and(Sanitizers.LINKS);
    return policy.sanitize(input);
}
```

### 8.3 CSRF対策

```java
// Spring Security自動対応
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());
        return http.build();
    }
}
```

---

## 9. 運用設計

### 9.1 ログ設計

#### ログ出力形式

```
[2026-01-19 10:00:00.123] [INFO] [user:artist123] [POST /api/artworks] [200] [1234ms]
```

#### ログレベル別出力内容

```java
// ERROR: エラー、例外
log.error("画像アップロード失敗: {}", e.getMessage(), e);

// WARN: 警告
log.warn("プラン制限に近づいています: user={}, current={}, limit={}",
    username, currentCount, limit);

// INFO: 重要なイベント
log.info("ユーザー登録: username={}, email={}", username, email);

// DEBUG: デバッグ情報（本番では無効）
log.debug("画像アップロード開始: filename={}, size={}", filename, size);
```

### 9.2 監視項目

| 項目 | 閾値 | アラート |
|-----|------|---------|
| エラー率 | > 1% | Slack通知 |
| レスポンス時間 | > 3秒 | Slack通知 |
| CPU使用率 | > 80% | メール通知 |
| メモリ使用率 | > 80% | メール通知 |
| ディスク使用率 | > 90% | メール通知 |

### 9.3 バックアップ・リストア手順

#### バックアップ

```bash
# Railway自動バックアップ（毎日深夜2時）
# 手動バックアップ
railway pg:backup
```

#### リストア

```bash
# 特定の日付にリストア
railway pg:restore backup_20260119
```

---

**承認者**: _____________
**承認日**: _____________

**END OF DOCUMENT**
