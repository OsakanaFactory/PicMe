# PicMe - 環境構築ガイド（外部サービス設定）

**作成日**: 2026-02-07
**バージョン**: 1.0

---

## 概要

PicMeは以下の外部サービスを利用しています。すべてのサービスは**未設定でも起動可能**で、フォールバック動作が用意されています。

| サービス | 用途 | 無料枠 | 未設定時の動作 |
|---------|------|--------|---------------|
| PostgreSQL | データベース | - | 必須（ローカル or Railway） |
| Cloudinary | 画像アップロード | 25GB + 25,000変換/月 | アップロード機能が無効 |
| SendGrid | メール送信 | 100通/日 | コンソールにURL出力 |
| Stripe | 決済・サブスクリプション | テストモード無料 | サブスク機能が無効 |
| Google AdSense | 広告表示 | - | 広告枠が空白 |

---

## 1. PostgreSQL（必須）

### ローカル開発

```bash
# インストール（Ubuntu/WSL）
sudo apt install postgresql postgresql-contrib

# データベース・ユーザー作成
sudo -u postgres psql
CREATE USER picme_user WITH PASSWORD 'picme_password';
CREATE DATABASE picme_db OWNER picme_user;
GRANT ALL PRIVILEGES ON DATABASE picme_db TO picme_user;
\q
```

### 環境変数

```
SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/picme_db
SPRING_DATASOURCE_USERNAME=picme_user
SPRING_DATASOURCE_PASSWORD=picme_password
```

---

## 2. Cloudinary（画像アップロード）

### アカウント作成手順

1. https://cloudinary.com/ にアクセス
2. 「Sign Up for Free」をクリック
3. アカウント情報を入力して登録
4. ダッシュボードの「Programmable Media」セクションに以下が表示される:
   - **Cloud Name**
   - **API Key**
   - **API Secret**

### 環境変数

```
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=123456789012345
CLOUDINARY_API_SECRET=your_api_secret
```

### 無料プラン制限

- ストレージ: 25GB
- 月間変換: 25,000回
- 月間帯域: 25GB

### 未設定時

CloudinaryConfigの`isConfigured()`がfalseを返し、画像アップロードエンドポイントがエラーを返します。プロフィール編集ではURL直接入力で代替可能です。

---

## 3. SendGrid（メール送信）

### アカウント作成手順

1. https://sendgrid.com/ にアクセス
2. 「Start for Free」をクリック
3. アカウント情報を入力して登録
4. メール認証を完了

### APIキー取得手順

1. ログイン後、左メニュー「Settings」→「API Keys」
2. 「Create API Key」をクリック
3. 名前: `PicMe Development` など
4. Permissions: 「Full Access」（開発用）または「Restricted Access」（Mail Sendのみ）
5. 表示されたAPIキーをコピー（**一度しか表示されません**）

### Sender Identity設定（必須）

1. 左メニュー「Settings」→「Sender Authentication」
2. 「Verify a Single Sender」をクリック
3. 送信元メールアドレスを登録（`SENDGRID_FROM_EMAIL`と一致させる）
4. 確認メールを承認

### 環境変数

```
SENDGRID_API_KEY=SG.xxxxxxxxxxxxxxxxxxxx
SENDGRID_FROM_EMAIL=noreply@yourdomain.com
SENDGRID_FROM_NAME=PicMe
```

### 無料プラン制限

- 1日100通まで
- 開発・テストには十分

### 未設定時

EmailServiceImplがコンソールにメール内容（認証URL等）を出力します。開発時はこのフォールバックで十分です。

---

## 4. Stripe（決済）

### アカウント作成手順

1. https://stripe.com/jp にアクセス
2. 「今すぐ始める」をクリック
3. アカウント情報を入力して登録

### テストモードAPIキー取得

1. ログイン後、ダッシュボード右上が「テスト」モードであることを確認
2. 左メニュー「開発者」→「APIキー」
3. 以下をコピー:
   - **公開可能キー**: `pk_test_...`（フロントエンドでは現在未使用）
   - **シークレットキー**: `sk_test_...` → `STRIPE_API_KEY`

### 商品・価格の作成

1. ダッシュボード「商品」→「商品を追加」
2. 3つの商品を作成:

| 商品名 | 価格 | 請求頻度 |
|--------|------|---------|
| PicMe Starter | ¥480 | 月次 |
| PicMe Pro | ¥680 | 月次 |
| PicMe Studio | ¥1,980 | 月次 |

3. 各商品の「価格ID」（`price_xxx`）をコピー

### Webhook設定

1. 「開発者」→「Webhook」→「エンドポイントを追加」
2. URL: `https://your-backend-url/api/subscriptions/webhook`
3. リッスンするイベント:
   - `checkout.session.completed`
   - `invoice.payment_succeeded`
   - `customer.subscription.deleted`
   - `customer.subscription.updated`
4. 「署名シークレット」をコピー → `STRIPE_WEBHOOK_SECRET`

### 環境変数

```
STRIPE_API_KEY=sk_test_xxxxxxxxxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxx
STRIPE_PRICE_STARTER=price_xxxxxxxxxxxx
STRIPE_PRICE_PRO=price_xxxxxxxxxxxx
STRIPE_PRICE_STUDIO=price_xxxxxxxxxxxx
```

### テスト用カード番号

| カード番号 | 説明 |
|-----------|------|
| 4242 4242 4242 4242 | 支払い成功 |
| 4000 0000 0000 0002 | 支払い拒否 |

有効期限: 任意の未来日、CVC: 任意の3桁

### 未設定時

StripeConfigの`isConfigured()`がfalseを返し、チェックアウトセッション作成がエラーを返します。プラン変更UIは表示されますが、決済処理は行えません。

---

## 5. Google AdSense（広告表示）

### 概要

AdSenseは本番デプロイ後に設定します。開発環境では不要です。

### 設定手順（本番環境用）

1. https://www.google.com/adsense/ にアクセス
2. Googleアカウントでログイン
3. サイトURL（本番ドメイン）を登録
4. 審査通過後、広告コードが発行される
5. フロントエンドの公開ページに広告コードを挿入

### 未設定時

広告枠が空白で表示されます。Freeプランユーザーの公開ページに影響しますが、機能的な問題はありません。

---

## クイックスタート（最小構成）

最低限の開発環境を構築するには、PostgreSQLのみ設定すれば起動できます。

```bash
# 1. バックエンド環境変数
cd backend
cp .env.example .env
# .env のデータベース設定を編集

# 2. フロントエンド環境変数
cd frontend
cp .env.example .env.local

# 3. バックエンド起動
cd backend
./mvnw spring-boot:run

# 4. フロントエンド起動
cd frontend
npm run dev
```

---

## トラブルシューティング

### Cloudinary: "Upload failed" エラー
- 環境変数のCloud Name、API Key、API Secretが正しいか確認
- Cloudinaryダッシュボードでアカウントがアクティブか確認

### SendGrid: メールが届かない
- Sender Identityの認証が完了しているか確認
- `SENDGRID_FROM_EMAIL`がSender Identityに登録したアドレスと一致しているか確認
- コンソールログで「SendGrid未設定」フォールバックが動作していないか確認

### Stripe: Webhook が動作しない
- ローカル開発では `stripe listen --forward-to localhost:8080/api/subscriptions/webhook` を使用
- Stripe CLIのインストール: `brew install stripe/stripe-cli/stripe`

---

**最終更新**: 2026-02-07
